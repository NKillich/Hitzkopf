<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hitzkopf üî• IGNITION</title>
    <style>
        /* --- CSS STYLES --- */
        body { background-color: #121212; color: #ffffff; font-family: 'Segoe UI', sans-serif; text-align: center; padding: 20px; margin: 0; touch-action: manipulation; overflow-x: hidden; padding-bottom: 60px; }
        h1 { color: #ff4500; margin: 0 0 10px 0; text-shadow: 0 0 10px #ff4500; }
        .card { background: #1e1e1e; padding: 20px; border-radius: 15px; max-width: 450px; margin: 0 auto; box-shadow: 0 4px 15px rgba(0,0,0,0.5); position: relative; margin-bottom: 20px; z-index: 1; }
        input, select { width: 85%; padding: 12px; margin: 5px 0; border-radius: 8px; border: 1px solid #333; background: #2c2c2c; color: white; font-size: 16px; text-align: center; }
        button { width: 100%; padding: 15px; margin: 10px 0; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; transition: transform 0.1s; }
        button:active { transform: scale(0.98); }
        .btn-primary { background: linear-gradient(45deg, #ff4500, #ff8c00); color: white; }
        .btn-secondary { background: #333; color: #ccc; }
        .btn-danger { background: #dc3545; color: white; margin-top: 5px; border: 1px solid #ffaaaa; }
        .btn-oil { background: #ffaa00; color: black; border: 2px solid #fff; margin-bottom: 10px; }
        .btn-ready { background: #28a745; color: white; margin-top: 20px; transition: background 0.3s; }
        .btn-ready:disabled { background: #1e7e34; opacity: 0.5; cursor: not-allowed; transform: none; filter: grayscale(0.8); }
        .hidden { display: none !important; }
        
        /* GAME ELEMENTS */
        .thermo-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .thermo-container { text-align: left; background: #222; padding: 8px; border-radius: 8px; border: 1px solid #333; }
        .thermo-top { display: flex; justify-content: space-between; font-size: 0.9rem; font-weight: bold; }
        .thermo-bar-bg { width: 100%; height: 8px; background: #333; border-radius: 10px; overflow: hidden; margin-top:5px; }
        .thermo-fill { height: 100%; width: 0%; transition: width 0.5s; }
        .option-container { display: flex; gap: 10px; margin-top: 20px; }
        .btn-option { flex: 1; background: #2c2c2c; border: 2px solid #444; padding: 30px 10px; font-size: 1.2rem; color: white; border-radius: 10px; }
        .btn-option.selected { border-color: #ff4500; background: #3e1e1e; }
        
        /* CHAT */
        .chat-box { background: #000; border: 1px solid #333; border-radius: 8px; height: 150px; overflow-y: auto; padding: 10px; margin-top: 20px; text-align: left; font-size: 0.8rem; display: flex; flex-direction: column; gap: 5px; }
        .chat-msg { padding: 5px; border-radius: 4px; background: #1a1a1a; border-left: 3px solid #555; }
        
        /* ADMIN */
        .admin-btn { position: fixed; top: 10px; right: 10px; background: #333; border-radius: 50%; width: 40px; height: 40px; z-index: 10000; cursor: pointer; border: 1px solid #555; display:flex; align-items:center; justify-content:center; font-size:20px;}
        .admin-menu { position: fixed; top: 0; right: 0; width: 250px; height: 100%; background: #111; border-left: 1px solid #ff4500; z-index: 10001; transform: translateX(100%); transition: transform 0.3s; padding: 20px; text-align: left; box-shadow: -5px 0 15px rgba(0,0,0,0.5); overflow-y:auto; }
        .admin-menu.open { transform: translateX(0); }
        .overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index: 10000; display:none; }

        /* SHOP */
        .card-selection-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; }
        .card-select-btn { background: #2c2c2c; border: 1px solid #555; border-radius: 8px; padding: 10px 5px; color: white; font-size: 0.7rem; cursor: pointer; }

        @keyframes shake { 0% { transform: translate(1px, 1px); } 50% { transform: translate(-1px, -2px); } 100% { transform: translate(1px, -1px); } }
        .shake-effect { animation: shake 0.5s; border: 2px solid red; }
        #notification-toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px); background: rgba(220, 53, 69, 0.95); color: white; padding: 15px 25px; border-radius: 50px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); z-index: 9999; font-weight: bold; font-size: 1.1rem; transition: transform 0.5s; }
        #notification-toast.show { transform: translateX(-50%) translateY(0); }
    </style>
</head>
<body>

    <div id="notification-toast">üî• Nachricht...</div>
    
    <div id="adminBtn" class="admin-btn hidden" onclick="toggleAdminMenu()">‚öôÔ∏è</div>
    <div id="adminOverlay" class="overlay" onclick="toggleAdminMenu()"></div>
    
    <div id="adminMenu" class="admin-menu">
        <h3 style="color:#ff4500; border-bottom:1px solid #333; margin-top:0;">Men√º</h3>
        
        <div id="hostActions" class="hidden">
            <p style="color:#888; font-size:0.8rem; margin-bottom:5px;">Host:</p>
            <button style="width:100%; margin-bottom:10px; padding:10px; background:#333;" onclick="adminForceNext()">‚è© Runde erzwingen</button>
            <button style="width:100%; margin-bottom:10px; padding:10px; background:#550000;" onclick="restartGame()">üîÑ Runde Neustarten</button>
            <button style="width:100%; margin-bottom:20px; padding:10px; background:#880000; color:white; font-weight:bold;" onclick="killLobby()">üß® LOBBY L√ñSCHEN</button>
            <hr style="border-color:#333; margin-bottom:20px;">
        </div>

        <button style="width:100%; margin-bottom:10px; padding:10px; background:#444;" onclick="leaveLobby()">üëã Lobby verlassen</button>
        <button style="width:100%; padding:10px; background:transparent; border:1px solid #666;" onclick="toggleAdminMenu()">Schlie√üen</button>
    </div>

    <h1>üî• Hitzkopf</h1>

    <div id="screen-start" class="card">
        <h3>Wer bist du?</h3>
        <input type="text" id="playerName" placeholder="Dein Name" maxlength="10">
        <br>
        <div style="margin:10px 0; border:1px solid #333; padding:10px; border-radius:8px;">
            <label>Schaden: <select id="inpDamage"><option value="10">10¬∞C</option><option value="60">60¬∞C (Speed)</option></select></label>
        </div>
        <button class="btn-primary" id="btnCreate">Neues Spiel erstellen</button>
        <p>- ODER -</p>
        <input type="text" id="roomInput" placeholder="Code" style="text-transform:uppercase">
        <button class="btn-secondary" id="btnJoin">Beitreten</button>
        <div id="rejoinMsg" class="hidden" style="color:#0f0; margin-top:10px;">Sitzung gefunden...</div>
    </div>

    <div id="screen-lobby" class="card hidden">
        <p>Raum-Code:</p>
        <div id="displayRoomCode" style="font-size:3rem; color:#ff8c00; font-weight:bold;">...</div>
        <div id="playerListLobby"></div>
        <div id="hostControls" class="hidden">
            <button class="btn-primary" id="btnFirstStart" onclick="firstStart()">üî• Spiel starten</button>
        </div>
        <p id="lobbyStatus" style="color: #888;">Warte auf Host...</p>
    </div>

    <div id="screen-game" class="card hidden">
        <div id="gameThermometers" class="thermo-grid"></div>
        <hr style="border-color:#333;">
        
        <div style="margin-bottom: 15px;">
            <span style="font-size: 2rem;">ü•µ</span>
            <div id="gameHotseatName" style="font-weight:bold; font-size:1.4rem; color:#ff4500;">...</div>
            <div id="gameInstruction" style="color:#aaa; font-size:0.9rem;">...</div>
        </div>
        
        <h3 id="gameQuestionText" style="margin: 20px 0;">Frage l√§dt...</h3>

        <div class="option-container">
            <button class="btn-option" id="optA" onclick="selectOption('A')">A</button>
            <button class="btn-option" id="optB" onclick="selectOption('B')">B</button>
        </div>

        <div id="strategySection">
            <p style="font-size:0.8rem; color:#888;">PLAN:</p>
            <select id="strategySelect">
                <option value="attack">üî¥ Angriff</option>
                <option value="invest">üÉè Taktik (Karte)</option>
            </select>
        </div>

        <button id="btnLockIn" class="btn-primary" style="margin-top:20px;" onclick="submitVote()">üîí Einloggen</button>
        <div id="votingStatus" style="margin-top:10px; color:#888; font-size:0.8rem;"></div>
        <div id="myInventory" style="margin-top:10px; border-top:1px solid #333; padding-top:5px; font-size:0.8rem;"></div>
    </div>

    <div id="screen-result" class="card hidden">
        <div id="resultThermometers" class="thermo-grid"></div>
        <h3>Wahrheit: <span id="resultTruth">?</span></h3>
        <div id="resultStatus" style="font-size:1.2rem; margin-bottom:10px;">...</div>

        <div id="shopArea" class="hidden" style="background:#222; padding:10px; border-radius:8px; margin-bottom:10px;">
            <h4>üÉè Belohnung w√§hlen:</h4>
            <div class="card-selection-grid">
                <button class="card-select-btn" onclick="takeCard('card_oil')">üõ¢Ô∏è √ñL</button>
                <button class="card-select-btn" onclick="takeCard('card_mirror')">üõ°Ô∏è SPIEGEL</button>
                <button class="card-select-btn" onclick="takeCard('card_ice')">üßä EIS</button>
            </div>
        </div>

        <div id="attackArea" class="hidden" style="background:#331111; padding:10px; border-radius:8px; margin-bottom:10px;">
            <h4>üî• Bestrafen:</h4>
            <button id="btnOil" class="btn-oil hidden" onclick="toggleOil()">üõ¢Ô∏è √ñL NUTZEN</button>
            <div id="targetButtons" style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;"></div>
            <button style="background:transparent; border:1px solid #666; color:#888; margin-top:5px; font-size:0.7rem;" onclick="skipAttack()">√úberspringen</button>
        </div>

        <div style="text-align:left; font-size:0.8rem; color:#666;">LOG:</div>
        <div id="gameLog" class="chat-box"></div>

        <button id="btnReady" class="btn-ready" onclick="sendReady()">üëç Bereit</button>
        <div id="readyStatusText" style="font-size:0.8rem; color:#888; margin-top:5px;"></div>
    </div>

    <div id="screen-gameover" class="card hidden">
        <h1 style="font-size:4rem;">‚ò†Ô∏è</h1>
        <h2>GAME OVER</h2>
        <h3 id="loserName" style="color:red;"></h3>
        <p>Gewinner: <span id="winnerName"></span></p>
        <button style="background:#444; margin-top:20px; width:100%; padding:15px; border:none; color:white;" onclick="leaveLobby()">üëã Lobby verlassen</button>
        <div id="hostRestartControls" class="hidden">
            <button style="background:#007bff; margin-top:20px;" onclick="restartGame()">üîÑ Neustart</button>
            <button style="background:#880000; margin-top:10px;" onclick="killLobby()">üß® LOBBY L√ñSCHEN</button>
        </div>
    </div>

    <script type="module">
        // GLOBAL ERROR CATCHER
        window.onerror = function(msg, url, line) {
            alert("Fehler: " + msg + "\nZeile: " + line);
        };

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, arrayUnion, onSnapshot, increment, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ------------------------------------------------------
        // ‚ö†Ô∏è HIER DEINE CONFIG EINF√úGEN ‚ö†Ô∏è
        // ------------------------------------------------------
const firebaseConfig = {
  apiKey: "AIzaSyBQ7c9JkZ3zWlyIjZLl1O1sJJOrKfYJbmA",
  authDomain: "hitzkopf-f0ea6.firebaseapp.com",
  projectId: "hitzkopf-f0ea6",
  storageBucket: "hitzkopf-f0ea6.firebasestorage.app",
  messagingSenderId: "828164655874",
  appId: "1:828164655874:web:1cab759bdb03bfb736101b"
};
        // ------------------------------------------------------

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // STATE
        let myName = sessionStorage.getItem("hk_name") || "";
        let currentRoom = sessionStorage.getItem("hk_room") || "";
        let isHost = false;
        let mySelection = null;
        let globalData = {};
        let actionDone = false;
        let oilActive = false;
        let retryButtonInterval = null;

        // AUTO LOGIN
        if(myName && currentRoom) {
            document.getElementById('rejoinMsg').classList.remove('hidden');
            setTimeout(() => joinRoom(currentRoom, myName), 500);
        }

        const questions = [
            { q: "Hund oder Katze?", a: "Hund üê∂", b: "Katze üê±" },
            { q: "Pizza oder D√∂ner?", a: "Pizza üçï", b: "D√∂ner ü•ô" },
            { q: "Sommer oder Winter?", a: "Sommer ‚òÄÔ∏è", b: "Winter ‚ùÑÔ∏è" },
            { q: "Bier oder Wein?", a: "Bier üç∫", b: "Wein üç∑" },
            { q: "Geld oder Liebe?", a: "Geld üí∞", b: "Liebe ‚ù§Ô∏è" }
        ];

        // --- CORE FUNCTIONS ---
        
        window.toggleMenu = () => {
            document.getElementById('adminMenu').classList.toggle('open');
            const overlay = document.getElementById('adminOverlay');
            overlay.style.display = document.getElementById('adminMenu').classList.contains('open') ? 'block' : 'none';
        }

        window.createGame = async () => {
            const btn = document.getElementById('btnCreate');
            btn.innerText = "Erstelle...";
            
            const name = document.getElementById('playerName').value.trim();
            const dmg = parseInt(document.getElementById('inpDamage').value);
            if(!name) { alert("Name fehlt!"); btn.innerText = "Neues Spiel erstellen"; return; }

            const code = Math.random().toString(36).substring(2,6).toUpperCase();
            
            // SAVE
            sessionStorage.setItem("hk_name", name);
            sessionStorage.setItem("hk_room", code);
            myName = name;
            currentRoom = code;
            isHost = true;

            try {
                await setDoc(doc(db, "lobbies", code), {
                    host: name,
                    status: "lobby",
                    playerData: { [name]: { temp: 0, inventory: [] } },
                    settings: { baseDamage: dmg },
                    votes: {},
                    ready: [],
                    log: []
                });
                listenToRoom(code);
            } catch (e) {
                alert("DB Fehler: " + e.message);
                btn.innerText = "Neues Spiel erstellen";
            }
        };

        window.joinGameBtn = () => {
            const name = document.getElementById('playerName').value.trim();
            const code = document.getElementById('roomInput').value.trim().toUpperCase();
            if(!name || !code) return alert("Daten fehlen");
            
            sessionStorage.setItem("hk_name", name);
            sessionStorage.setItem("hk_room", code);
            joinRoom(code, name);
        };

        async function joinRoom(code, name) {
            myName = name;
            currentRoom = code;
            const ref = doc(db, "lobbies", code);
            const snap = await getDoc(ref);
            
            if(!snap.exists()) {
                sessionStorage.clear();
                alert("Raum nicht gefunden");
                location.reload();
                return;
            }

            if(snap.data().host === name) isHost = true;

            // Add player if new
            if(!snap.data().playerData[name]) {
                const update = {};
                update[`playerData.${name}`] = { temp: 0, inventory: [] };
                await updateDoc(ref, update);
            }
            listenToRoom(code);
        }

        // --- LISTENER (THE BRAIN) ---
        function listenToRoom(code) {
            document.getElementById('screen-start').classList.add('hidden');
            
            onSnapshot(doc(db, "lobbies", code), (snap) => {
                if(!snap.exists()) { alert("Lobby gel√∂scht!"); sessionStorage.clear(); location.reload(); return; }
                
                const data = snap.data();
                globalData = data;
                const players = Object.keys(data.playerData);
                
                // HOST CHECK
                if(data.host === myName) {
                    isHost = true;
                    document.getElementById('hostControls').classList.remove('hidden');
                    document.getElementById('hostActions').classList.remove('hidden');
                    document.getElementById('hostRestartControls').classList.remove('hidden');
                } else {
                    document.getElementById('hostControls').classList.add('hidden');
                    document.getElementById('hostActions').classList.add('hidden');
                    document.getElementById('hostRestartControls').classList.add('hidden');
                }

                // RENDER ALWAYS
                renderHeader(data);
                renderLog(data.log);
                
                // DEATH CHECK (INSTANT)
                let dead = null;
                players.forEach(p => { if(data.playerData[p].temp >= 100) dead = p; });
                
                // IF DEAD AND NOT FINISHED -> HOST FINISHES IT
                if(dead && data.status !== 'finished') {
                    if(isHost) updateDoc(doc(db, "lobbies", code), { status: 'finished', loser: dead });
                }

                // SHOW GAME OVER IF FINISHED OR DEAD DETECTED
                if(data.status === 'finished' || dead) {
                    showScreen('screen-gameover');
                    document.getElementById('loserName').innerText = (data.loser || dead) + " ist explodiert!";
                    return; // STOP EVERYTHING ELSE
                }

                // ROUTING
                if(data.status === 'lobby') {
                    showScreen('screen-lobby');
                    document.getElementById('displayRoomCode').innerText = code;
                    document.getElementById('playerListLobby').innerHTML = players.join('<br>');
                } 
                else if (data.status === 'game') {
                    showScreen('screen-game');
                    setupGameScreen(data);
                    
                    // HOST AUTO TRANSITION
                    if(isHost) {
                        const votes = Object.keys(data.votes || {}).length;
                        if(votes >= players.length) {
                            updateDoc(doc(db, "lobbies", code), { status: 'result' });
                        }
                    }
                }
                else if (data.status === 'result') {
                    showScreen('screen-result');
                    setupResultScreen(data);
                    
                    // HOST AUTO NEXT ROUND
                    if(isHost && data.ready && data.ready.length >= players.length) {
                        triggerNextRound();
                    }
                }
            });
        }

        // --- SCREEN LOGIC ---
        function setupGameScreen(data) {
            // Reset local state for new round
            if(document.getElementById('gameQuestionText').innerText !== data.currentQ.q) {
                actionDone = false;
                mySelection = null;
                document.getElementById('btnLockIn').classList.remove('hidden');
                document.getElementById('votingStatus').innerText = "";
                document.getElementById('btnReady').classList.remove('loading');
                if(retryButtonInterval) clearInterval(retryButtonInterval);
            }

            document.getElementById('gameQuestionText').innerText = data.currentQ.q;
            document.getElementById('optA').innerText = data.currentQ.a;
            document.getElementById('optB').innerText = data.currentQ.b;
            
            const hotseat = data.hotseat;
            if(myName === hotseat) {
                document.getElementById('gameHotseatName').innerText = "DU bist der Hitzkopf!";
                document.getElementById('strategySection').classList.add('hidden');
            } else {
                document.getElementById('gameHotseatName').innerText = hotseat + " ist der Hitzkopf";
                document.getElementById('strategySection').classList.remove('hidden');
            }

            // Voting Status
            const count = Object.keys(data.votes || {}).length;
            const total = Object.keys(data.playerData).length;
            document.getElementById('votingStatus').innerText = `Gew√§hlt: ${count} / ${total}`;
        }

        function setupResultScreen(data) {
            // Truth
            const truth = data.votes[data.hotseat]?.choice;
            const truthText = truth === 'A' ? data.currentQ.a : data.currentQ.b;
            document.getElementById('resultTruth').innerText = truthText;

            const myVote = data.votes[myName];
            const statusEl = document.getElementById('resultStatus');
            const shop = document.getElementById('shopArea');
            const attack = document.getElementById('attackArea');
            const readyBtn = document.getElementById('btnReady');

            shop.classList.add('hidden');
            attack.classList.add('hidden');

            // Ready Text
            const readyCount = (data.ready || []).length;
            const total = Object.keys(data.playerData).length;
            document.getElementById('readyStatusText').innerText = `Bereit: ${readyCount} / ${total}`;

            if(myName === data.hotseat) {
                statusEl.innerText = "Deine Wahl.";
                statusEl.style.color = "#fff";
                readyBtn.disabled = false;
                readyBtn.innerText = "üëç Bereit";
                 if(data.ready && data.ready.includes(myName)) {
                     readyBtn.disabled = true;
                     readyBtn.innerText = "Warte...";
                }
            } else if (myVote) {
                if(myVote.choice === truth) {
                    statusEl.innerText = "RICHTIG! üéâ";
                    statusEl.style.color = "#0f0";
                    
                    // SHOW ACTIONS IF NOT DONE
                    if(!actionDone) {
                        readyBtn.disabled = true;
                        readyBtn.innerText = "Erst Belohnung!";
                        
                        if(myVote.strategy === 'invest') {
                            shop.classList.remove('hidden');
                        } else {
                            attack.classList.remove('hidden');
                            
                            // FORCE RENDER LOOP
                            if(retryButtonInterval) clearInterval(retryButtonInterval);
                            retryButtonInterval = setInterval(() => {
                                if(!actionDone) renderAttackButtons();
                            }, 500);
                            renderAttackButtons();
                        }
                    } else {
                        readyBtn.disabled = false;
                        readyBtn.innerText = "üëç Bereit";
                        if(data.ready && data.ready.includes(myName)) {
                             readyBtn.disabled = true;
                             readyBtn.innerText = "Warte...";
                        }
                    }
                } else {
                    statusEl.innerText = "FALSCH ‚ùå";
                    statusEl.style.color = "#f00";
                    actionDone = true; // Nothing to do
                    readyBtn.disabled = false;
                    readyBtn.innerText = "üëç Bereit";
                     if(data.ready && data.ready.includes(myName)) {
                         readyBtn.disabled = true;
                         readyBtn.innerText = "Warte...";
                    }
                }
            }
        }

        // --- ACTIONS ---
        window.renderAttackButtons = () => {
            const div = document.getElementById('targetButtons');
            if(div.innerHTML !== "") return; // Already rendered
            
            const players = Object.keys(globalData.playerData);
            
            players.forEach(p => {
                if(p !== myName) {
                    const b = document.createElement('button');
                    b.className = "btn-danger";
                    b.innerText = p;
                    b.onclick = () => performAttack(p);
                    div.appendChild(b);
                }
            });
            
            // Oil Check
            const inv = globalData.playerData[myName].inventory || [];
            if(inv.includes('card_oil')) document.getElementById('btnOil').classList.remove('hidden');
        };

        window.performAttack = async (target) => {
            actionDone = true;
            if(retryButtonInterval) clearInterval(retryButtonInterval);
            
            document.getElementById('attackArea').classList.add('hidden');
            document.getElementById('btnReady').disabled = false;
            document.getElementById('btnReady').innerText = "üëç Bereit";

            let dmg = globalData.settings.baseDamage || 10;
            let logMsg = `üî• ${myName} trifft ${target} (+${dmg}¬∞)`;
            
            if(oilActive) {
                dmg *= 2;
                logMsg = `üõ¢Ô∏è ${myName} √ºbergie√üt ${target} mit √ñl (+${dmg}¬∞)`;
                // Remove Card
                 const inv = [...globalData.playerData[myName].inventory];
                 const idx = inv.indexOf('card_oil');
                 if(idx > -1) inv.splice(idx, 1);
                 await updateDoc(doc(db, "lobbies", currentRoom), { [`playerData.${myName}.inventory`]: inv });
            }

            // Mirror Check (Simplified)
            const tInv = globalData.playerData[target].inventory || [];
            if(tInv.includes('card_mirror')) {
                 logMsg = `üõ°Ô∏è ${target} reflektiert Angriff von ${myName}!`;
                 const newTInv = [...tInv];
                 newTInv.splice(newTInv.indexOf('card_mirror'), 1);
                 // Reflect damage to me
                 await updateDoc(doc(db, "lobbies", currentRoom), {
                    [`playerData.${myName}.temp`]: increment(dmg),
                    [`playerData.${target}.inventory`]: newTInv,
                    log: arrayUnion(logMsg)
                });
            } else {
                await updateDoc(doc(db, "lobbies", currentRoom), {
                    [`playerData.${target}.temp`]: increment(dmg),
                    log: arrayUnion(logMsg)
                });
            }
            
            oilActive = false;
        };

        window.takeCard = async (card) => {
            actionDone = true;
            document.getElementById('shopArea').classList.add('hidden');
            document.getElementById('btnReady').disabled = false;
            document.getElementById('btnReady').innerText = "üëç Bereit";

            await updateDoc(doc(db, "lobbies", currentRoom), {
                [`playerData.${myName}.inventory`]: arrayUnion(card),
                log: arrayUnion(`üÉè ${myName} nimmt eine Karte`)
            });
        };

        window.sendReady = async () => {
            document.getElementById('btnReady').disabled = true;
            await updateDoc(doc(db, "lobbies", currentRoom), { ready: arrayUnion(myName) });
        };

        window.skipAttack = () => {
            actionDone = true;
            if(retryButtonInterval) clearInterval(retryButtonInterval);
            document.getElementById('attackArea').classList.add('hidden');
            document.getElementById('btnReady').disabled = false;
            document.getElementById('btnReady').innerText = "üëç Bereit";
        };

        window.toggleOil = () => {
            oilActive = !oilActive;
            document.getElementById('btnOil').style.background = oilActive ? "red" : "#ffaa00";
        };

        // --- IGNITION START ---
        window.firstStart = async () => {
             const btn = document.getElementById('btnFirstStart');
             btn.innerText = "Starte...";
             
             const players = Object.keys(globalData.playerData);
             const q = questions[Math.floor(Math.random() * questions.length)];
             
             await updateDoc(doc(db, "lobbies", currentRoom), {
                 status: 'game',
                 hotseat: players[0],
                 currentQ: q,
                 votes: {},
                 ready: [],
                 log: []
             });
        };

        // --- NEXT ROUND ---
        window.triggerNextRound = async () => {
            const players = Object.keys(globalData.playerData);
            const currentHotseat = globalData.hotseat;
            let idx = players.indexOf(currentHotseat);
            let next = players[(idx + 1) % players.length];
            
            const q = questions[Math.floor(Math.random() * questions.length)];
            
            // Ice Check
             let updates = {};
             let logAdditions = [];
             players.forEach(p => {
                 const inv = globalData.playerData[p].inventory || [];
                 const iceIndex = inv.indexOf('card_ice');
                 if(iceIndex > -1) {
                     const newInv = [...inv];
                     newInv.splice(iceIndex, 1);
                     const currentTemp = globalData.playerData[p].temp || 0;
                     let newTemp = currentTemp - 10;
                     if(newTemp < 0) newTemp = 0;
                     updates[`playerData.${p}.inventory`] = newInv;
                     updates[`playerData.${p}.temp`] = newTemp;
                     logAdditions.push(`üßä ${p} k√ºhlt ab (-10¬∞C)`);
                 }
             });
             if(logAdditions.length) updates['log'] = logAdditions; // This overwrites old log

             updates['status'] = 'game';
             updates['hotseat'] = next;
             updates['currentQ'] = q;
             updates['votes'] = {};
             updates['ready'] = [];
            
            await updateDoc(doc(db, "lobbies", currentRoom), updates);
        };

        // --- HELPER ---
        function showScreen(id) {
            ['screen-start', 'screen-lobby', 'screen-game', 'screen-result', 'screen-gameover'].forEach(s => {
                document.getElementById(s).classList.add('hidden');
            });
            document.getElementById(id).classList.remove('hidden');
        }

        function renderHeader(data) {
            // Updates Thermometers on all screens (Game & Result)
            const targets = ['gameThermometers', 'resultThermometers'];
            const players = Object.keys(data.playerData);
            
            targets.forEach(tid => {
                const el = document.getElementById(tid);
                if(!el) return;
                el.innerHTML = "";
                
                players.forEach(p => {
                    const d = data.playerData[p];
                    let color = "#0f0";
                    if(d.temp > 50) color = "#ff0";
                    if(d.temp > 80) color = "#f00";
                    
                    let icons = "";
                    if(p === data.hotseat) icons = "ü•µ";
                    if(d.inventory) d.inventory.forEach(() => icons += "üÉè");
                    
                    el.innerHTML += `
                    <div class="thermo-container">
                        <div class="thermo-top"><span>${p} ${icons}</span><span>${d.temp}¬∞C</span></div>
                        <div class="thermo-bar-bg"><div class="thermo-fill" style="width:${Math.min(d.temp, 100)}%; background:${color}"></div></div>
                    </div>`;
                });
            });
            
            // Render Inventory
            const myInv = document.getElementById('myInventory');
            if(myInv) {
                const items = data.playerData[myName]?.inventory || [];
                myInv.innerText = items.length ? "Inventar: " + items.join(" ") : "Keine Karten";
            }
        }

        function renderLog(log) {
            const el = document.getElementById('gameLog');
            if(el && log) el.innerHTML = log.map(l => `<div class="chat-msg">${l}</div>`).join('');
        }

        // --- EVENT LISTENERS ---
        document.getElementById('btnCreate').onclick = window.createGame;
        document.getElementById('btnJoin').onclick = window.joinGameBtn;

        // --- VOTE ---
        window.selectOption = (opt) => {
            mySelection = opt;
            document.getElementById('optA').style.border = opt=='A' ? '2px solid orange' : '2px solid #444';
            document.getElementById('optB').style.border = opt=='B' ? '2px solid orange' : '2px solid #444';
        };

        window.submitVote = async () => {
            if(!mySelection) return alert("W√§hle A oder B");
            const strat = document.getElementById('strategySelect').value;
            const vote = { choice: mySelection, strategy: strat };
            document.getElementById('btnLockIn').classList.add('hidden');
            
            const updates = {};
            updates[`votes.${myName}`] = vote;
            await updateDoc(doc(db, "lobbies", currentRoom), updates);
        };
        
        window.leaveLobby = () => { sessionStorage.clear(); location.reload(); };
        window.killLobby = async () => { await deleteDoc(doc(db, "lobbies", currentRoom)); };
        window.adminForceNext = window.triggerNextRound;
        window.forceNextRound = window.triggerNextRound; // Alias fix
        
        window.restartGame = async () => {
             const players = Object.keys(globalData.playerData);
             const newP = {};
             players.forEach(p => newP[p] = {temp:0, inventory:[]});
             await updateDoc(doc(db, "lobbies", currentRoom), { 
                 status: 'lobby', playerData: newP, votes: {}, log: [], ready: []
             });
        };

    </script>
</body>
</html>