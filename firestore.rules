rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper-Funktionen
    function isValidLobbyId(lobbyId) {
      return lobbyId.size() == 4 && lobbyId.matches('^[A-Z0-9]+$');
    }
    
    function isValidString(value, maxLength) {
      return value is string && value.size() <= maxLength && value.size() > 0;
    }
    
    function isValidNumber(value, min, max) {
      return value is int && value >= min && value <= max;
    }
    
    function isValidPlayerName(name) {
      return isValidString(name, 20);
    }
    
    function isValidStatus(status) {
      return status in ['lobby', 'countdown', 'game', 'result', 'winner'];
    }
    
    function isValidGameMode(mode) {
      return mode in ['party', 'strategisch'];
    }
    
    // Lobbies Collection
    match /lobbies/{lobbyId} {
      
      // Lesen: Erlaubt für authentifizierte User (inkl. anonyme)
      // Validierung der Lobby-ID für zusätzliche Sicherheit
      allow read: if request.auth != null && isValidLobbyId(lobbyId);
      
      // Erstellen: Nur für authentifizierte User (inkl. anonyme) mit gültiger Lobby-ID und korrekter Struktur
      allow create: if request.auth != null && isValidLobbyId(lobbyId)
        && request.resource.data.keys().hasAll(['host', 'hostName', 'status', 'createdAt', 'players', 'config', 'votes', 'ready', 'log', 'hotseat', 'currentQ', 'roundId', 'lobbyReady'])
        && isValidPlayerName(request.resource.data.host)
        && request.resource.data.host == request.resource.data.hostName
        && isValidStatus(request.resource.data.status)
        && request.resource.data.status == 'lobby'
        && request.resource.data.players is map
        && request.resource.data.players.size() <= 20 // Max 20 Spieler
        && request.resource.data.config is map
        && isValidNumber(request.resource.data.config.dmg, 1, 100)
        && isValidNumber(request.resource.data.config.speed, 1, 60)
        && isValidNumber(request.resource.data.config.startTemp, 0, 50)
        && isValidNumber(request.resource.data.config.maxTemp, 50, 200)
        && isValidGameMode(request.resource.data.config.gameMode)
        && request.resource.data.config.categories is list
        && request.resource.data.config.categories.size() <= 20
        && request.resource.data.votes is map
        && request.resource.data.ready is list
        && request.resource.data.ready.size() <= 20
        && request.resource.data.log is list
        && request.resource.data.log.size() <= 1000
        && request.resource.data.roundId is int
        && request.resource.data.roundId >= 0
        && request.resource.data.roundId <= 10000;
      
      // Aktualisieren: Nur für authentifizierte User (inkl. anonyme) mit Validierung der geänderten Felder
      allow update: if request.auth != null && isValidLobbyId(lobbyId)
        // Status-Validierung
        && (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['status']) 
            || isValidStatus(request.resource.data.status))
        // RoundId-Validierung
        && (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['roundId'])
            || (request.resource.data.roundId is int 
                && request.resource.data.roundId >= 0 
                && request.resource.data.roundId <= 10000
                && request.resource.data.roundId >= resource.data.roundId))
        // Players-Validierung
        && (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['players'])
            || (request.resource.data.players is map
                && request.resource.data.players.size() <= 20))
        // Votes-Validierung
        && (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['votes'])
            || (request.resource.data.votes is map
                && request.resource.data.votes.size() <= 20))
        // Ready-Liste-Validierung
        && (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['ready'])
            || (request.resource.data.ready is list
                && request.resource.data.ready.size() <= 20))
        // UsedQuestions-Validierung (IDs statt Indizes)
        && (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['usedQuestions'])
            || (request.resource.data.usedQuestions is list
                && request.resource.data.usedQuestions.size() <= 1000
                && request.resource.data.usedQuestions.size() >= 0))
        // Log-Validierung
        && (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['log'])
            || (request.resource.data.log is list
                && request.resource.data.log.size() <= 1000))
        // Hotseat-Validierung
        && (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['hotseat'])
            || (request.resource.data.hotseat is string
                && request.resource.data.hotseat.size() <= 20))
        // Config-Validierung (wenn geändert)
        && (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['config'])
            || (request.resource.data.config is map
                && (!request.resource.data.config.diff(resource.data.config).affectedKeys().hasAny(['dmg'])
                    || isValidNumber(request.resource.data.config.dmg, 1, 100))
                && (!request.resource.data.config.diff(resource.data.config).affectedKeys().hasAny(['speed'])
                    || isValidNumber(request.resource.data.config.speed, 1, 60))
                && (!request.resource.data.config.diff(resource.data.config).affectedKeys().hasAny(['maxTemp'])
                    || isValidNumber(request.resource.data.config.maxTemp, 50, 200))
                && (!request.resource.data.config.diff(resource.data.config).affectedKeys().hasAny(['gameMode'])
                    || isValidGameMode(request.resource.data.config.gameMode))));
      
      // Löschen: Nicht erlaubt (Lobbies sollten nicht gelöscht werden können)
      allow delete: if false;
    }
  }
}
